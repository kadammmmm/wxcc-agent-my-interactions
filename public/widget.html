<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Past Calls</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
    label { display: grid; gap: 4px; font-size: 12px; }
    input, select { padding: 6px 8px; font-size: 14px; }
    button { padding: 8px 12px; cursor: pointer; }
    table { border-collapse: collapse; margin-top: 16px; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; }
    th { background: #f7f7f7; text-align: left; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h2>Previous Customer Interactions</h2>

  <div class="row">
    <label>Agent email
      <input id="agentEmail" placeholder="agent@example.com" />
    </label>
    <label>Hours back
      <input id="hours" type="number" min="1" value="168" />
    </label>
    <button id="login">Authorize Search</button>
    <button id="load">Load</button>
  </div>

  <p class="muted">
    Tip. If you see “search_not_authorized”, click “Authorize Search” then return here and click Load.
  </p>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th>Start</th>
        <th>End</th>
        <th>Duration</th>
        <th>ANI</th>
        <th>DNIS</th>
        <th>Queue</th>
        <th>Agent</th>
        <th>Task Id</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function fmtTs(ts) { return ts ? new Date(ts).toLocaleString() : ""; }
    function fmtDur(ms) { if (!ms) return ""; const s = Math.round(ms / 1000); const m = Math.floor(s / 60); const r = s % 60; return `${m}m ${r}s`; }

    async function loadData() {
      const agentEmail = document.getElementById('agentEmail').value.trim();
      const hours = document.getElementById('hours').value || '168';
      const url = `/api/tasks/search?hours=${encodeURIComponent(hours)}${agentEmail ? `&agentEmail=${encodeURIComponent(agentEmail)}` : ""}`;

      const res = await fetch(url);
      if (!res.ok) {
        const text = await res.text();
        alert(`Failed to load: ${res.status}. ${text}`);
        return;
      }
      const data = await res.json();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      (data.items || []).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtTs(row.startTime)}</td>
          <td>${fmtTs(row.endTime)}</td>
          <td>${fmtDur(row.duration)}</td>
          <td>${row.ani || ""}</td>
          <td>${row.dnis || ""}</td>
          <td>${row.queueName || ""}</td>
          <td>${row.agentEmail || ""}</td>
          <td>${row.id}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('tbl').style.display = '';
    }

    document.getElementById('load').addEventListener('click', loadData);
    document.getElementById('login').addEventListener('click', () => {
      window.location.href = '/oauth/login';
    });

    // If running in Agent Desktop, prefill from query params
    const params = new URLSearchParams(location.search);
    if (params.get('agentEmail')) {
      document.getElementById('agentEmail').value = params.get('agentEmail');
    }
  </script>
</body>
</html>
